name: Deploy Inference Model (EC2)

# Manual deploy only: run via Actions -> Deploy Inference Model (EC2) -> Run workflow

permissions:
  contents: read

on:
  workflow_dispatch:
  schedule:
    - cron: "30 13 * * 0"  # Sundays 8:30am ET (13:30 UTC)

jobs:
  deploy-inference-model:
    runs-on: ubuntu-latest

    steps:
      - name: Pull model from S3 and restart inference on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            APP_DIR="/home/ubuntu/my-mlops-demo"
            S3_URI="s3://thurmans-demo-models/mlops/models/model.pkl"

            # Matches docker-compose mount: ./models/model.pkl:/tmp/model.pkl:ro
            MODEL_DIR="${APP_DIR}/models"
            MODEL_TMP="${MODEL_DIR}/model.pkl.tmp"
            MODEL_DST="${MODEL_DIR}/model.pkl"

            echo "[deploy-model] Pulling model from S3 -> ${MODEL_DST}"
            mkdir -p "${MODEL_DIR}"
            aws s3 cp "${S3_URI}" "${MODEL_TMP}"
            test -s "${MODEL_TMP}"
            mv -f "${MODEL_TMP}" "${MODEL_DST}"
            ls -lah "${MODEL_DST}"

            echo "[deploy-model] Pulling inference image + restarting inference only"
            cd "${APP_DIR}"
            docker compose pull inference
            docker compose up -d --no-deps --force-recreate inference
            docker compose ps inference

            echo "[deploy-model] Waiting for inference to become ready..."
            for i in {1..20}; do
              if curl -fsS "http://127.0.0.1:8000/ready" >/dev/null; then
                echo "[deploy-model] Inference is ready ✅"
                break
              fi
              echo "[deploy-model] Not ready yet... ($i/20)"
              sleep 2
            done

            echo "[deploy-model] /ready:"
            curl -fsS "http://127.0.0.1:8000/ready" | cat
            echo

            echo "[deploy-model] /model/info:"
            curl -fsS "http://127.0.0.1:8000/model/info" | cat
            echo

            echo "[deploy-model] Done ✅"
